{% extends 'Market/base.html' %}
{% load static %}
{% block title %}–ú—ñ–π –º–∞–≥–∞–∑–∏–Ω - –ì–æ–ª–æ–≤–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞{% endblock %}

{% block content %}
{% csrf_token %}
<!-- –ö–æ—Å–º—ñ—á–Ω–∞ –ö–æ—Ä–∑–∏–Ω–∞ -->
<div id="cart" class="cosmic-cart" style="display: none;">
    <div class="cart-header">
        <h3 class="cart-title">–ö–æ—Å–º—ñ—á–Ω–∞ –ö–æ—Ä–∑–∏–Ω–∞</h3>
        <button onclick="closeCart()" class="cart-close-btn">‚úï</button>
    </div>—Ç—ã
    <ul id="cart-items" class="cart-items"></ul>
    <div id="cart-total" class="cart-total"></div>
</div>

<section class="new_page_obj">
    <h2 class="section-title">–ù–æ–≤—ñ —Ç–æ–≤–∞—Ä–∏ (–∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 2 –≥–æ–¥–∏–Ω–∏)</h2>
    <div class="products-grid">
        {% for product in new_page_obj %}
            <div class="product">
                <img src="{% static 'Market/imgs/2ca0915fa0953adf6be69526cd1de89b.jpg' %}" alt="{{ product.name }}">
                <p><strong>{{ product.name }}</strong></p>
                <p>{{ product.description }}</p>
                <p><em>{{ product.price }} –≥—Ä–Ω</em></p>

                <!-- –°–∏—Å—Ç–µ–º–∞ –ª–∞–π–∫–æ–≤/–¥–∏–∑–ª–∞–π–∫—ñ–≤ -->
                <div class="rating-section">
                    <div class="rating-buttons">
                        <button class="like-btn" onclick="rateProduct({{ product.pk }}, true)">
                            üëç <span class="likes-count">{{ product.annotated_likes_count|default:0 }}</span>
                        </button>
                        <button class="dislike-btn" onclick="rateProduct({{ product.pk }}, false)">
                            üëé <span class="dislikes-count">{{ product.annotated_dislikes_count|default:0 }}</span>
                        </button>
                    </div>
                    <div class="rating-score">
                        –†–µ–π—Ç–∏–Ω–≥: <span class="score">{{ product.annotated_rating_score|default:0 }}</span>
                    </div>
                </div>

                <div class="product-actions">
                    <div class="action-buttons-row">
                        <button class="action-btn edit-btn" onclick="window.location.href='{% url 'Market:update_product' product.pk %}'">
                            <div class="btn-content">
                                <i class="btn-icon">‚úèÔ∏è</i>
                                <span class="btn-text">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</span>
                            </div>
                        </button>
                        <button class="action-btn delete-btn" onclick="window.location.href='{% url 'Market:delete_product' product.pk %}'">
                            <div class="btn-content">
                                <i class="btn-icon">üóëÔ∏è</i>
                                <span class="btn-text">–í–∏–¥–∞–ª–∏—Ç–∏</span>
                            </div>
                        </button>
                    </div>
                    <button class="action-btn cart-btn" onclick="addToCart({{ product.pk }})">
                        <i class="btn-icon">üõí</i>
                        <span class="btn-text">–î–æ–¥–∞—Ç–∏ –¥–æ –∫–æ—à–∏–∫–∞</span>
                    </button>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –Ω–æ–≤—ã—Ö -->
    <div class="pagination">
        {% if new_page_obj.has_previous %}
            <a class="arrow" href="?new_page={{ new_page_obj.previous_page_number }}">&lsaquo;</a>
        {% endif %}
        {% for num in new_page_obj.paginator.page_range %}
            {% if num == new_page_obj.number %}
                <span class="active">{{ num }}</span>
            {% else %}
                <a href="?new_page={{ num }}">{{ num }}</a>
            {% endif %}
        {% endfor %}
        {% if new_page_obj.has_next %}
            <a class="arrow" href="?new_page={{ new_page_obj.next_page_number }}">&rsaquo;</a>
        {% endif %}
    </div>
</section>

<section class="other_products">
    <h2 class="section-title">–Ü–Ω—à—ñ —Ç–æ–≤–∞—Ä–∏</h2>
    <div class="products-grid">
        {% for product in page_obj %}
            <div class="product">
                <img src="{% static 'Market/imgs/2ca0915fa0953adf6be69526cd1de89b.jpg' %}" alt="{{ product.name }}">
                <p><strong>{{ product.name }}</strong></p>
                <p>{{ product.description }}</p>
                <p><em>{{ product.price }} –≥—Ä–Ω</em></p>

                <!-- –°–∏—Å—Ç–µ–º–∞ –ª–∞–π–∫—ñ–≤/–¥–∏–∑–ª–∞–π–∫—ñ–≤ -->
                <div class="rating-section">
                    <div class="rating-buttons">
                        <button class="like-btn" onclick="rateProduct({{ product.pk }}, true)">
                            üëç <span class="likes-count">{{ product.annotated_likes_count|default:0 }}</span>
                        </button>
                        <button class="dislike-btn" onclick="rateProduct({{ product.pk }}, false)">
                            üëé <span class="dislikes-count">{{ product.annotated_dislikes_count|default:0 }}</span>
                        </button>
                    </div>
                    <div class="rating-score">
                        –†–µ–π—Ç–∏–Ω–≥: <span class="score">{{ product.annotated_rating_score|default:0 }}</span>
                    </div>
                </div>

                <div class="product-actions">
                    <div class="action-buttons-row">
                        <button class="action-btn edit-btn" onclick="window.location.href='{% url 'Market:update_product' product.pk %}'">
                            <div class="btn-content">
                                <i class="btn-icon">‚úèÔ∏è</i>
                                <span class="btn-text">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</span>
                            </div>
                        </button>
                        <button class="action-btn delete-btn" onclick="window.location.href='{% url 'Market:delete_product' product.pk %}'">
                            <div class="btn-content">
                                <i class="btn-icon">üóëÔ∏è</i>
                                <span class="btn-text">–í–∏–¥–∞–ª–∏—Ç–∏</span>
                            </div>
                        </button>
                    </div>
                    <button class="action-btn cart-btn" onclick="addToCart({{ product.pk }})">
                        <i class="btn-icon">üõí</i>
                        <span class="btn-text">–î–æ–¥–∞—Ç–∏ –¥–æ –∫–æ—à–∏–∫–∞</span>
                    </button>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö -->
    <div class="pagination">
        {% if page_obj.has_previous %}
            <a class="arrow" href="?page={{ page_obj.previous_page_number }}">&lsaquo;</a>
        {% endif %}
        {% for num in page_obj.paginator.page_range %}
            {% if num == page_obj.number %}
                <span class="active">{{ num }}</span>
            {% else %}
                <a href="?page={{ num }}">{{ num }}</a>
            {% endif %}
        {% endfor %}
        {% if page_obj.has_next %}
            <a class="arrow" href="?page={{ page_obj.next_page_number }}">&rsaquo;</a>
        {% endif %}
    </div>
</section>

<section class="new-arrivals">
    <h2 class="section-title">–ù–æ–≤–∏–Ω–∫–∏</h2>
    <div class="products-grid">
        <div class="product">
            <img src="{% static 'Market/imgs/2ca0915fa0953adf6be69526cd1de89b.jpg' %}" alt="–¢–æ–≤–∞—Ä 1">
            <p><strong>–¢–æ–≤–∞—Ä 1</strong></p>
            <p>–û–ø–∏—Å —Ç–æ–≤–∞—Ä—É 1</p>
            <p><em>299 –≥—Ä–Ω</em></p>
        </div>
        <div class="product">
            <img src="{% static 'Market/imgs/2ca0915fa0953adf6be69526cd1de89b.jpg' %}" alt="–¢–æ–≤–∞—Ä 2">
            <p><strong>–¢–æ–≤–∞—Ä 2</strong></p>
            <p>–û–ø–∏—Å —Ç–æ–≤–∞—Ä—É 2</p>
            <p><em>399 –≥—Ä–Ω</em></p>
        </div>
        <div class="product">
            <img src="{% static 'Market/imgs/2ca0915fa0953adf6be69526cd1de89b.jpg' %}" alt="–¢–æ–≤–∞—Ä 3">
            <p><strong>–¢–æ–≤–∞—Ä 3</strong></p>
            <p>–û–ø–∏—Å —Ç–æ–≤–∞—Ä—É 3</p>
            <p><em>199 –≥—Ä–Ω</em></p>
        </div>
    </div>
</section>

<section class="best-sellers">
    <h2 class="section-title">–•—ñ—Ç–∏ –ø—Ä–æ–¥–∞–∂—ñ–≤</h2>
    <div class="products-grid">
        <div class="product">
            <img src="{% static 'Market/imgs/2ca0915fa0953adf6be69526cd1de89b.jpg' %}" alt="–¢–æ–≤–∞—Ä 4">
            <p><strong>–•—ñ—Ç –ø—Ä–æ–¥–∞–∂—ñ–≤</strong></p>
            <p>–û–ø–∏—Å —Ç–æ–≤–∞—Ä—É 4</p>
            <p><em>599 –≥—Ä–Ω</em></p>
        </div>
    </div>
</section>


<script>
function rateProduct(productId, isLike) {
    const formData = new FormData();
    formData.append('is_like', isLike);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    fetch(`/market/rate-product/${productId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ–≤–∞—Ä–∞
            const productCard = document.querySelector(`button[onclick="rateProduct(${productId}, true)"]`).closest('.product');

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            productCard.querySelector('.likes-count').textContent = data.likes_count;
            productCard.querySelector('.dislikes-count').textContent = data.dislikes_count;
            productCard.querySelector('.score').textContent = data.rating_score;

            // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            const button = isLike ? productCard.querySelector('.like-btn') : productCard.querySelector('.dislike-btn');
            button.classList.add('rating-animation');
            setTimeout(() => {
                button.classList.remove('rating-animation');
            }, 600);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function addToCart(productId) {
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    fetch(`/market/add-to-cart/${productId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showCart();
            updateCartDisplay(data.cart_items);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function showCart() {
    const cart = document.getElementById('cart');
    cart.style.display = 'block';
}

function closeCart() {
    const cart = document.getElementById('cart');
    cart.style.display = 'none';
}

function updateCartDisplay(cartItems) {
    const cartItemsList = document.getElementById('cart-items');
    const cartTotal = document.getElementById('cart-total');

    cartItemsList.innerHTML = '';
    let total = 0;

    if (cartItems.length === 0) {
        cartItemsList.innerHTML = '<li class="cart-empty">–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</li>';
        cartTotal.innerHTML = `–í—Å—å–æ–≥–æ: 0.00 –≥—Ä–Ω`;
        return;
    }

    cartItems.forEach(item => {
        const listItem = document.createElement('li');
        listItem.className = 'cart-item';
        listItem.innerHTML = `
            <div class="cart-item-header">
                <div class="cart-item-name">${item.name}</div>
                <button class="cart-remove-btn" onclick="removeFromCart(${item.id})" title="–í–∏–¥–∞–ª–∏—Ç–∏ –∑ –∫–æ—à–∏–∫–∞">‚úï</button>
            </div>
            <div class="cart-item-controls">
                <div class="quantity-controls">
                    <button class="quantity-btn minus" onclick="updateQuantity(${item.id}, ${item.quantity - 1})">‚àí</button>
                    <input type="number" class="quantity-input" value="${item.quantity}" min="1" onchange="updateQuantity(${item.id}, this.value)">
                    <button class="quantity-btn plus" onclick="updateQuantity(${item.id}, ${item.quantity + 1})">+</button>
                </div>
                <div class="cart-item-price">
                    ${item.price} –≥—Ä–Ω √ó ${item.quantity} = ${(parseFloat(item.price) * item.quantity).toFixed(2)} –≥—Ä–Ω
                </div>
            </div>
        `;
        cartItemsList.appendChild(listItem);
        total += parseFloat(item.price) * item.quantity;
    });

    cartTotal.innerHTML = `–í—Å—å–æ–≥–æ: ${total.toFixed(2)} –≥—Ä–Ω`;
}

function showNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #28a745;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 1001;
        animation: slideDown 0.3s ease;
    `;
    notification.textContent = message;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function updateQuantity(productId, newQuantity) {
    const formData = new FormData();
    formData.append('quantity', newQuantity);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    fetch(`/market/update-cart/${productId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateCartDisplay(data.cart_items);
            showNotification(data.message);
        } else {
            showNotification('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ');
    });
}

function removeFromCart(productId) {
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    fetch(`/market/remove-from-cart/${productId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateCartDisplay(data.cart_items);
            showNotification(data.message);
        } else {
            showNotification('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ —Ç–æ–≤–∞—Ä—É');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ —Ç–æ–≤–∞—Ä—É');
    });
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('load', function() {
    fetch('/market/get-cart/')
    .then(response => {
        if (!response.ok) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É');
            return;
        }
        return response.json();
    })
    .then(data => {
        if (data && data.cart_items && data.cart_items.length > 0) {
            updateCartDisplay(data.cart_items);
        }
    })
    .catch(error => {
        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ—Ä–∑–∏–Ω—ã:', error);
    });
});
</script>

<style>
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

.add-to-cart-btn:hover {
    background: #218838 !important;
    transform: translateY(-2px);
}
</style>
{% endblock %}

